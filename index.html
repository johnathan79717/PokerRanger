<!DOCTYPE html>
<html>
  <head>
    <title>PokerRanger</title>
    <style>
      table, th, td {
        border: 1px solid black;
      }
      td {
        text-align: center;
      }
    </style>
  </head>

  <body>
    <h1> PokerRanger </h1>
    <p>Source code: <a href="https://github.com/johnathan79717/PokerRanger">https://github.com/johnathan79717/PokerRanger</a></p>
  <table id="hands"></table>
  <p><button onclick="reset();"> Clear </button></p>
  <h2>You selected <span id="percentage">0</span>% of hands.</h2>
  <h2>Save this range</h2>
  <p>
    Name:
    <input type="text" id="range-name" placeholder="Button opening range">
    <button onclick="saveRange();">Save</button>
  </p>
  <h2> Your saved ranges </h2>
  <ul id="saved-ranges"></ul>
  
  <script>
    let checkboxes = {};

    function reset() {
      for (let hand in checkboxes) {
        if (checkboxes[hand].checked) {
          checkboxes[hand].click();
        }
      }
    }

    function displayRange(rangeName) {
      reset();
      let range = window.localStorage.getItem(rangeName).split(',');
      for (let hand of range) {
        checkboxes[hand].click();
      }
    }

    function refreshSavedRanges() {
      let listSavedRanges = document.getElementById("saved-ranges");
      while (listSavedRanges.firstChild) {
        listSavedRanges.removeChild(listSavedRanges.firstChild);
      }
      for (let rangeName in window.localStorage) {
        let li = document.createElement("li");
        let a = document.createElement("a");
        a.textContent = rangeName;
        a.href="javascript:";
        a.onclick = () => displayRange(rangeName);
        li.appendChild(a);
        li.appendChild(document.createTextNode(' '));
        let button = document.createElement("button");
        button.textContent = "Delete";
        button.onclick = function(rangeName) {
          return function() {
            window.localStorage.removeItem(rangeName);
            refreshSavedRanges();
          };
        }(rangeName);
        li.appendChild(button);
        listSavedRanges.appendChild(li);
      }
    }

    refreshSavedRanges();

    function saveRange() {
      let selectedHands = getSelectedHands();
      let rangeName = document.getElementById("range-name").value;
      window.localStorage.setItem(rangeName, selectedHands);
      refreshSavedRanges();
    }

    function rank(n) {
      switch (n) {
        case 14: return 'A';
        case 13: return 'K';
        case 12: return 'Q';
        case 11: return 'J';
        case 10: return 'T';
        default: return n.toString();
      }
    }
    function getHandName(i, j) {
      if (i < j) {
        [i, j] = [j, i];
      }
      return rank(i) + rank(j);
    }

    function getSelectedHands() {
      let checkboxes = document.getElementsByTagName('input');
      let hands = [];
      for (let checkbox of checkboxes) {
        if (checkbox.checked) {
          hands.push(checkbox.id);
        }
      }
      return hands;
    }

    let colors = {
      offsuit: "#B0E0E6",
      suited: "#FFE4B5",
      pair: "#32CD32",
      selected: "#00BFFF",
    };

    function onHandClicked(checkbox, td, hand) {
      if (checkbox.checked) {
        td.style.backgroundColor = colors.selected;
      } else if (hand[hand.length-1] == 'o') {
        td.style.backgroundColor = colors.offsuit;
      } else if (hand[hand.length-1] == 's') {
        td.style.backgroundColor = colors.suited;
      } else {
        td.style.backgroundColor = colors.pair;
      }
      let selectedHands = getSelectedHands();
      let cnt = 0;
      for (let hand of selectedHands) {
        if (hand[hand.length-1] == 'o') {
          cnt += 12;
        } else if (hand[hand.length-1] == 's') {
          cnt += 4;
        } else {
          cnt += 6;
        }
      }
      let percentage = cnt / 1326;
      percentage = Math.round(percentage * 10000) / 100;
      document.getElementById('percentage')
              .textContent = percentage.toString();
    }

    let table = document.getElementById('hands');
    for (let i = 14; i >= 2; i--) {
      let tr = document.createElement('tr');
      for (let j = 14; j >= 2; j--) {
        let hand = getHandName(i, j);
        let td = document.createElement('td');
        if (i < j) {
          hand += 'o';
          td.style.backgroundColor = colors.offsuit;
        } else if (i > j) {
          hand += 's';
          td.style.backgroundColor = colors.suited;
        } else {
          td.style.backgroundColor = colors.pair;
        }
        let checkbox = document.createElement('input');
        checkbox.id = hand;
        checkbox.type = 'checkbox';
        checkbox.style = 'display:none';
        checkbox.onclick = function(c, t, h) {
          return function() {
            onHandClicked(c, t, h);
          };
        }(checkbox, td, hand);
        checkboxes[hand] = checkbox;
        let text = document.createTextNode(hand);
        let label = document.createElement('label');
        label.appendChild(checkbox);
        label.appendChild(text);
        td.appendChild(label);
        tr.appendChild(td);
      }
      table.appendChild(tr);
    }
  </script>
  </body>
</html>
